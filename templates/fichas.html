<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .breadcrumb-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .breadcrumb-modern .breadcrumb-item a {
            color: #fff;
            text-decoration: none;
        }
        .breadcrumb-modern .breadcrumb-item.active {
            color: #ffd700;
        }
        .breadcrumb-modern .breadcrumb-item + .breadcrumb-item::before {
            content: "\f105";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-5" style="width: 90%; margin: 0 auto;">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-modern">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Catálogos</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('configurar_catalogo', catalogo_id=subcategoria.categoria.catalogo_id) }}"><i class="fas fa-folder"></i> {{ subcategoria.categoria.catalogo.codigo }} - {{ subcategoria.categoria.catalogo.descripcion }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('categoria', categoria_id=subcategoria.categoria_id) }}"><i class="fas fa-tag"></i> {{ subcategoria.categoria.cod_categoria }}</a></li>
                <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-image"></i> {{ subcategoria.cod_categoria }}</li>
            </ol>
        </nav>
        <a href="{{ url_for('categoria', categoria_id=subcategoria.categoria_id) }}" class="btn btn-secondary mb-3">Volver</a>
        {% if session.usuario in ['admin', 'producto'] %}
        <button class="btn btn-primary mb-3" onclick="window.location.href='{{ url_for('add_fila', subcategoria_id=subcategoria.id) }}'">
            <i class="fas fa-plus"></i> Añadir Fila
        </button>
        {% endif %}
        
        <!-- Contador de totales -->
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> Total de productos: <strong>{{ total_general }}</strong>
            {% for marca in marcas %}
                | {{ marca }}: <strong>{{ totales_marca[marca] }}</strong>
            {% endfor %}
        </div>
        
        <div class="row mb-3 fw-bold">
            {% for marca in marcas %}
            <div class="col">{{ marca }}</div>
            {% endfor %}
            <div class="col-2">Totales Fila</div>
            <div class="col-1">Acciones</div>
        </div>
        {% for ficha in fichas %}
        <div class="row mb-4">
            {% for marca in marcas %}
            <div class="col">
                {% set tarjeta = ficha.tarjetas | selectattr('marca', 'equalto', marca) | list | first %}
                {% if tarjeta and tarjeta.producto %}
                {% set producto = tarjeta.producto %}
                {% set datos_manuales = datos_manuales_dict.get(producto.sku, [{}])[0] if datos_manuales_dict.get(producto.sku) else None %}
                {% set atributos = producto.atributos | selectattr('valor') | list %}
                
                <div class="card h-100" style="font-size: 0.75rem;">
                    <!-- Fila superior: 2 bloques -->
                    <div class="row g-0">
                        <!-- Bloque superior izquierda: Imagen -->
                        <div class="col-6" style="border-right: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen }}" class="img-fluid" alt="Imagen" style="max-height: 120px; object-fit: contain; width: 100%; padding: 5px;" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center\' style=\'height: 120px;\'><i class=\'fas fa-image fa-2x text-muted\'></i></div>';">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center" style="height: 120px; background-color: #f8f9fa;">
                                <i class="fas fa-image fa-2x text-muted"></i>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Bloque superior derecha: Datos Manuales -->
                        <div class="col-6 p-2" style="border-bottom: 1px solid #dee2e6;">
                            <strong style="font-size: 0.7rem;">DATOS COMERCIALES</strong>
                            <table class="table table-sm mb-0" style="font-size: 0.65rem;">
                                <tbody>
                                    {% if datos_manuales %}
                                    <tr><td class="p-0"><strong>PVP:</strong></td><td class="p-0 text-end">{{ "%.2f"|format(datos_manuales.pvp) }}€</td></tr>
                                    <tr><td class="p-0"><strong>Vendidas:</strong></td><td class="p-0 text-end">{{ datos_manuales.unidades_vendidas }}</td></tr>
                                    <tr><td class="p-0"><strong>Stock:</strong></td><td class="p-0 text-end">{{ datos_manuales.inventario }}</td></tr>
                                    <tr><td class="p-0"><strong>F.Entrada:</strong></td><td class="p-0 text-end">{{ datos_manuales.fecha_entrada }}</td></tr>
                                    <tr><td class="p-0"><strong>Uds.Ent:</strong></td><td class="p-0 text-end">{{ datos_manuales.unidades_entrada }}</td></tr>
                                    {% else %}
                                    <tr><td colspan="2" class="text-center text-muted p-1">Sin datos</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Fila inferior: 2 bloques -->
                    <div class="row g-0">
                        <!-- Bloque inferior izquierda: Datos Producto -->
                        <div class="col-6 p-2" style="border-right: 1px solid #dee2e6;">
                            <strong style="font-size: 0.7rem;">PRODUCTO</strong>
                            <div style="font-size: 0.65rem;">
                                <div><strong>SKU:</strong> {{ producto.sku }}</div>
                                <div class="text-truncate" title="{{ producto.titulo }}"><strong>Título:</strong> {{ producto.titulo[:30] }}...</div>
                                <div><strong>Marca:</strong> <span class="badge bg-primary" style="font-size: 0.6rem;">{{ producto.marca }}</span></div>
                                <div><strong>EAN:</strong> {{ producto.ean or 'N/A' }}</div>
                                <div><strong>Estado:</strong> {{ producto.estado_referencia or 'N/A' }}</div>
                                <div><strong>Color:</strong> {{ producto.color or 'N/A' }}</div>
                            </div>
                        </div>
                        
                        <!-- Bloque inferior derecha: Atributos -->
                        <div class="col-6 p-2">
                            <strong style="font-size: 0.7rem;">ATRIBUTOS ({{ atributos|length }})</strong>
                            <div style="font-size: 0.65rem; max-height: 100px; overflow-y: auto;">
                                {% if atributos %}
                                <table class="table table-sm mb-0" style="font-size: 0.6rem;">
                                    <tbody>
                                    {% for attr in atributos[:5] %}
                                    <tr>
                                        <td class="p-0" style="width: 50%;"><strong>{{ attr.atributo }}:</strong></td>
                                        <td class="p-0">{{ attr.valor[:20] }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% if atributos|length > 5 %}
                                    <tr><td colspan="2" class="p-0 text-center"><small>+ {{ atributos|length - 5 }} más</small></td></tr>
                                    {% endif %}
                                    </tbody>
                                </table>
                                {% else %}
                                <div class="text-muted text-center p-1">Sin atributos</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pie: Dimensiones y Fabricante -->
                    <div class="card-footer p-1" style="font-size: 0.65rem; background-color: #f8f9fa;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-ruler-combined"></i> <strong>Dim:</strong> {{ producto.dimensiones or 'N/A' }}
                            </div>
                            <div>
                                {% if datos_manuales and datos_manuales.fabricante %}
                                <i class="fas fa-industry"></i> <strong>Fab:</strong> {{ datos_manuales.fabricante }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-1">
                            <a href="{{ url_for('ver_producto', id=producto.id) }}" class="btn btn-info btn-sm" style="font-size: 0.6rem; padding: 2px 6px;" title="Ver producto completo">
                                <i class="fas fa-eye"></i> Ver
                            </a>
                            {% if session.usuario in ['admin', 'producto'] %}
                            <button type="button" class="btn btn-danger btn-sm" style="font-size: 0.6rem; padding: 2px 6px;" data-bs-toggle="modal" data-bs-target="#deleteTarjetaModal{{ tarjeta.id }}" title="Eliminar">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card text-center h-100">
                    <div class="card-body d-flex align-items-center justify-content-center">
                        {% if session.usuario in ['admin', 'producto'] %}
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addModal" data-ficha="{{ ficha.id }}" data-marca="{{ marca }}">
                            <i class="fas fa-plus"></i> Añadir
                        </button>
                        {% else %}
                        <span class="text-muted"><i class="fas fa-ban"></i> Sin producto</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            <div class="col-2 d-flex align-items-center justify-content-start">
                {% set total_vendidas = namespace(value=0) %}
                {% set total_stock = namespace(value=0) %}
                {% set total_entrada = namespace(value=0) %}
                {% for tarjeta in ficha.tarjetas %}
                    {% if tarjeta.producto and tarjeta.producto.sku %}
                        {% set dm = datos_manuales_dict.get(tarjeta.producto.sku, [{}])[0] if datos_manuales_dict.get(tarjeta.producto.sku) else None %}
                        {% if dm %}
                            {% set total_vendidas.value = total_vendidas.value + (dm.unidades_vendidas or 0) %}
                            {% set total_stock.value = total_stock.value + (dm.inventario or 0) %}
                            {% set total_entrada.value = total_entrada.value + (dm.unidades_entrada or 0) %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
                <div style="font-size: 0.9rem;">
                    <div><i class="fas fa-shopping-cart"></i> <strong>Vendidas:</strong> <span class="badge bg-info">{{ total_vendidas.value }}</span></div>
                    <div><i class="fas fa-box"></i> <strong>Stock:</strong> <span class="badge bg-success">{{ total_stock.value }}</span></div>
                    <div><i class="fas fa-truck"></i> <strong>Entrada:</strong> <span class="badge bg-warning">{{ total_entrada.value }}</span></div>
                </div>
            </div>
            <div class="col-1 d-flex align-items-center">
                {% if session.usuario in ['admin', 'producto'] %}
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteFilaModal{{ ficha.id }}">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal para Añadir Tarjeta -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Añadir Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addForm" method="POST">
                <div class="modal-body">
                    <input type="hidden" id="fichaId" name="ficha_id">
                    <input type="hidden" id="marca" name="marca">
                    <input type="hidden" id="producto_id" name="producto_id" required>
                    
                    <div class="mb-3">
                        <label for="buscar_producto" class="form-label">Buscar Producto</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="buscar_producto" placeholder="Buscar por SKU o título..." autocomplete="off">
                        </div>
                        <small class="text-muted">Escribe al menos 2 caracteres para buscar</small>
                    </div>
                    
                    <div id="resultados_busqueda" class="list-group mb-3" style="max-height: 300px; overflow-y: auto; display: none;"></div>
                    
                    <div id="producto_seleccionado" class="alert alert-success" style="display: none;">
                        <strong>Producto seleccionado:</strong>
                        <div id="producto_info"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnAnadir" disabled>Añadir</button>
                </div>
            </form>
        </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const addModal = document.getElementById('addModal');
        let marcaActual = '';
        const categoriasDisponibles = '{{ categorias | safe }}'.split(',').filter(c => c.trim());
        
        addModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const fichaId = button.getAttribute('data-ficha');
            const marca = button.getAttribute('data-marca');
            marcaActual = marca;
            
            document.getElementById('fichaId').value = fichaId;
            document.getElementById('marca').value = marca;
            document.getElementById('addForm').action = `/add_tarjeta/${fichaId}/${encodeURIComponent(marca)}`;
            
            // Resetear formulario
            document.getElementById('buscar_producto').value = '';
            document.getElementById('producto_id').value = '';
            document.getElementById('resultados_busqueda').style.display = 'none';
            document.getElementById('producto_seleccionado').style.display = 'none';
            document.getElementById('btnAnadir').disabled = true;
        });
        
        // Búsqueda de productos con debounce
        let timeoutId;
        document.getElementById('buscar_producto').addEventListener('input', function(e) {
            clearTimeout(timeoutId);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('resultados_busqueda').style.display = 'none';
                return;
            }
            
            timeoutId = setTimeout(() => {
                // Si hay categorías disponibles, buscar en la primera (normalmente solo hay una por subcategoría)
                const categoriaFiltro = categoriasDisponibles.length > 0 ? categoriasDisponibles[0] : '';
                const url = `/buscar_productos_ajax?q=${encodeURIComponent(query)}&marca=${encodeURIComponent(marcaActual)}${categoriaFiltro ? '&categoria=' + encodeURIComponent(categoriaFiltro) : ''}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const resultados = document.getElementById('resultados_busqueda');
                        resultados.innerHTML = '';
                        
                        if (data.productos.length === 0) {
                            resultados.innerHTML = '<div class="list-group-item">No se encontraron productos</div>';
                            resultados.style.display = 'block';
                            return;
                        }
                        
                        data.productos.forEach(p => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="me-auto">
                                        <strong>${p.sku}</strong> - ${p.titulo || 'Sin título'}
                                        <br><small class="text-muted">${p.marca} | ${p.dimensiones || ''} | ${p.color || ''}</small>
                                    </div>
                                </div>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                seleccionarProducto(p);
                            });
                            resultados.appendChild(item);
                        });
                        
                        resultados.style.display = 'block';
                    })
                    .catch(err => console.error('Error en búsqueda:', err));
            }, 300);
        });
        
        function seleccionarProducto(producto) {
            document.getElementById('producto_id').value = producto.id;
            document.getElementById('producto_info').innerHTML = `
                <strong>${producto.sku}</strong> - ${producto.titulo || 'Sin título'}<br>
                <small>${producto.marca} | ${producto.dimensiones || 'N/A'} | ${producto.color || 'N/A'}</small>
            `;
            document.getElementById('producto_seleccionado').style.display = 'block';
            document.getElementById('resultados_busqueda').style.display = 'none';
            document.getElementById('btnAnadir').disabled = false;
        }
    </script>

    <!-- Modales de confirmación de eliminación -->
    {% for ficha in fichas %}
        <!-- Modal para eliminar fila -->
        <div class="modal fade" id="deleteFilaModal{{ ficha.id }}" tabindex="-1" aria-labelledby="deleteFilaModalLabel{{ ficha.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteFilaModalLabel{{ ficha.id }}">
                            <i class="fas fa-exclamation-triangle"></i> Confirmar eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">¿Estás seguro de que deseas eliminar toda la fila <strong>{{ ficha.fila_numero }}</strong>?</p>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-info-circle"></i> Esta acción no se puede deshacer y eliminará todas las tarjetas de esta fila.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <a href="{{ url_for('delete_fila', id=ficha.id) }}" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal para eliminar cada tarjeta -->
        {% for tarjeta in ficha.tarjetas %}
        {% if tarjeta.producto %}
        <div class="modal fade" id="deleteTarjetaModal{{ tarjeta.id }}" tabindex="-1" aria-labelledby="deleteTarjetaModalLabel{{ tarjeta.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteTarjetaModalLabel{{ tarjeta.id }}">
                            <i class="fas fa-exclamation-triangle"></i> Confirmar eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">¿Estás seguro de que deseas eliminar el producto <strong>{{ tarjeta.producto.sku }}</strong>?</p>
                        <p class="text-muted">{{ tarjeta.producto.titulo or 'Sin título' }}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <a href="{{ url_for('delete_tarjeta', id=tarjeta.id) }}" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    {% endfor %}

</body>
</html>